{% extends "base-bare.html" %}

{% block page_body %}
<form class="space-y needs-validation" novalidate action="{{ url_for('.wizp2') }}" method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="container py-4">
    <div class="card card-md">
      <div class="card-body text-center py-4 p-sm-5">
        <h1 class="mt-5">Datos de tus Alumnos!</h1>
        <p class="text-secondary">
          Necesitamos algunos datos para poder entregar una buena atención.
        </p>
      </div>

      {% for a in range(apoderado.alumnos_registro)%}
      <div class="card-body">

        <div class="space-y">
          <div>
            <h4>Alumno {{ a+1 }}</h4>
          </div>
          <div class="row row-cols-2 g-4">
            <div>
              <label class="form-label"> Nombre </label>
              <input type="text" name="nombre_alumno_{{a+1}}" placeholder="Ingrese nombre y apellido" class="form-control" required />
            </div>
            <div>
              <label class="form-label"> Curso </label>
              <div>
                <select class="form-select" required name="curso_alumno_{{a+1}}">
                  <option value="">Seleccione un curso... </option>
                  {% for c in cursos %}
                  <option value="{{c}}">{{c}}</option>
                  {% endfor %}

                </select>
              </div>
            </div>
            <div>
              <label class="form-label"> Edad </label>
              <input type="number" placeholder="Edad" name="edad_alumno_{{a+1}}" class="form-control" max="19" min="4" required />
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Restricciones Alimenticias</label>
            <p class="text-muted small mb-2">Registra alergias o restricciones alimenticias del alumno (opcional).</p>
            <div id="restricciones_lista_{{a+1}}"></div>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="agregarRestriccion({{a+1}})">
              + Agregar restricción
            </button>
            <input type="hidden" name="restricciones_json_{{a+1}}" id="restricciones_json_{{a+1}}" value="[]">
          </div>


        </div>

      </div>
      {% endfor %}
    </div>
    <div class="row align-items-center mt-3">
      <div class="col-4">
        <div class="progress progress-1">
          <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 67%" role="progressbar" aria-valuenow="66" aria-valuemin="0" aria-valuemax="100" aria-label="66% Complete">
            <span class="visually-hidden">66% Complete</span>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="btn-list justify-content-end">
          {# <a href="https://google.cl" class="btn btn-link link-secondary btn-2"> Continuar más tarde </a> #}
          <button type="submit" class="btn btn-primary btn-2">Continuar</button>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock page_body %}

{% block page_scripts %}
<script>
  function agregarRestriccion(num) {
    const lista = document.getElementById('restricciones_lista_' + num);
    const row = document.createElement('div');
    row.className = 'row g-2 mb-2 align-items-center restriccion-row';
    row.innerHTML = `
      <div class="col">
        <input type="text" class="form-control form-control-sm" placeholder="Ej: Maní, Gluten"
               oninput="actualizarJson(${num})">
      </div>
      <div class="col">
        <select class="form-select form-select-sm" onchange="actualizarJson(${num})">
          <option value="Alergia">Alergia</option>
          <option value="Intolerancia">Intolerancia</option>
          <option value="No le Gusta">No le Gusta</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-sm btn-ghost-danger"
                onclick="this.closest('.restriccion-row').remove(); actualizarJson(${num})">✕</button>
      </div>
    `;
    lista.appendChild(row);
    actualizarJson(num);
  }

  function actualizarJson(num) {
    const lista = document.getElementById('restricciones_lista_' + num);
    const restricciones = [];
    lista.querySelectorAll('.restriccion-row').forEach(row => {
      const nombre = row.querySelector('input[type="text"]').value.trim();
      const motivo = row.querySelector('select').value;
      if (nombre) restricciones.push({ nombre: nombre, motivo: motivo });
    });
    document.getElementById('restricciones_json_' + num).value = JSON.stringify(restricciones);
  }

  const form_p1 = document.querySelector('.needs-validation');

  form_p1.addEventListener('submit', (e) => {
    for (let i = 1; i <= {{ apoderado.alumnos_registro }}; i++) actualizarJson(i);

    if (!form_p1.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
    }

    form_p1.classList.add('was-validated');
  }, false);
</script>
{% endblock page_scripts%}
