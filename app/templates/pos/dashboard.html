{% extends "base-pos.html" %}

{% block page_header -%}
<div class="page-header d-print-none text-white">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <!-- Page pre-title -->
        <h1 class="page-title">Punto de Venta</h1>
      </div>
    </div>
  </div>
</div>
{% endblock page_header -%}

{% block page_body %}
<div class="container-xl">
  <div class="row row-deck row-cards">
    <div class="col-12">
      <div class="row row-cards">
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-primary text-white avatar"><!-- Download SVG icon from http://tabler.io/icons/icon/currency-dollar -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" class="icon icon-1">
                      <path d="M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2" />
                      <path d="M12 3v3m0 12v3" />
                    </svg></span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">4 Abonos/Pedidos por pagar</div>
                  <div class="text-secondary">Total $17.300.-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-green text-white avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-soup">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M4 11h16a1 1 0 0 1 1 1v.5c0 1.5 -2.517 5.573 -4 6.5v1a1 1 0 0 1 -1 1h-8a1 1 0 0 1 -1 -1v-1c-1.687 -1.054 -4 -5 -4 -6.5v-.5a1 1 0 0 1 1 -1" />
                      <path d="M12 4a2.4 2.4 0 0 0 -1 2a2.4 2.4 0 0 0 1 2" />
                      <path d="M16 4a2.4 2.4 0 0 0 -1 2a2.4 2.4 0 0 0 1 2" />
                      <path d="M8 4a2.4 2.4 0 0 0 -1 2a2.4 2.4 0 0 0 1 2" />
                    </svg></span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">103/127 almuerzos para hoy</div>
                  <div class="text-secondary">80% de capacidad</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-pink text-white avatar"><!-- Download SVG icon from http://tabler.io/icons/icon/brand-x -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-nfc">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M11 20a3 3 0 0 1 -3 -3v-11l5 5" />
                      <path d="M13 4a3 3 0 0 1 3 3v11l-5 -5" />
                      <path d="M4 7a3 3 0 0 1 3 -3h10a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3l0 -10" />
                    </svg></span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">0% cobertura NFC</div>
                  <div class="text-secondary">0 de 130 alumnos con tag</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-facebook text-white avatar"><!-- Download SVG icon from http://tabler.io/icons/icon/brand-facebook -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" class="icon icon-1">
                      <path d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3" />
                    </svg></span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">$93.500</div>
                  <div class="text-secondary">En abonos por canjear</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-12">
      <div class="row row-cards">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <p class="mb-3"><strong>Plato de Fondo</strong> más popular en 2026:</p>
              <div class="progress progress-separated mb-3">
                <div class="progress-bar bg-primary" role="progressbar" style="width: 63%" aria-label="Mechada con Pure"></div>
                <div class="progress-bar bg-cyan" role="progressbar" style="width: 25%" aria-label="Lasaña Boloñesa"></div>
                <div class="progress-bar bg-success" role="progressbar" style="width: 12%" aria-label="Tofu con Verduras"></div>
              </div>
              <div class="row">
                <div class="col-auto d-flex align-items-center pe-2">
                  <span class="legend me-2 bg-primary"></span>
                  <span>Mechada con Puré</span>
                  <span class="d-none d-md-inline d-lg-none d-xxl-inline ms-2 text-secondary">450 Ordenes</span>
                </div>
                <div class="col-auto d-flex align-items-center px-2">
                  <span class="legend me-2 bg-cyan"></span>
                  <span>Lasaña Boloñesa</span>
                  <span class="d-none d-md-inline d-lg-none d-xxl-inline ms-2 text-secondary">370 Ordenes</span>
                </div>
                <div class="col-auto d-flex align-items-center px-2">
                  <span class="legend me-2 bg-success"></span>
                  <span>Tofu con Verduras</span>
                  <span class="d-none d-md-inline d-lg-none d-xxl-inline ms-2 text-secondary">172 Ordenes</span>
                </div>
              </div>
              <hr>
              <p class="mb-3">Abonos:</p>
              <div class="progress progress-separated mb-3">
                <div class="progress-bar bg-primary" role="progressbar" style="width: 86%" aria-label="Abonos por cobrar"></div>
                <div class="progress-bar bg-success" role="progressbar" style="width: 14%" aria-label="Abonos Canjeados"></div>
              </div>
              <div class="row">
                <div class="col-auto d-flex align-items-center pe-2">
                  <span class="legend me-2 bg-primary"></span>
                  <span>Abonos por cobrar</span>
                  <span class="d-none d-md-inline d-lg-none d-xxl-inline ms-2 text-secondary">$ 67.300.-</span>
                </div>
                <div class="col-auto d-flex align-items-center px-2">
                  <span class="legend me-2 bg-success"></span>
                  <span>Abonos Canjeados</span>
                  <span class="d-none d-md-inline d-lg-none d-xxl-inline ms-2 text-secondary">$ 18.100.-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-12">
      <div class="card card-md sticky-top">
        <div class="card-stamp card-stamp-lg">
          <div class="card-stamp-icon bg-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-nfc">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M11 20a3 3 0 0 1 -3 -3v-11l5 5" />
              <path d="M13 4a3 3 0 0 1 3 3v11l-5 -5" />
              <path d="M4 7a3 3 0 0 1 3 -3h10a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3l0 -10" />
            </svg>
          </div>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-10">
              <h3 class="h1">Tags NFC</h3>
              <div class="markdown">
                Porfavor tenga preparado su celular, con bluethooth y NFC Activados
              </div>
              <div class="mt-3">
                <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modal-validacion-tag" aria-label="Abre Modal de Validacion de TAG">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-nfc">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M11 20a3 3 0 0 1 -3 -3v-11l5 5" />
                    <path d="M13 4a3 3 0 0 1 3 3v11l-5 -5" />
                    <path d="M4 7a3 3 0 0 1 3 -3h10a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3l0 -10" />
                  </svg>
                  Validar TAG
                </a>

                <a href="#" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modal-registro-tag" aria-label="Abre Modal de Registro de TAG">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-nfc">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M11 20a3 3 0 0 1 -3 -3v-11l5 5" />
                    <path d="M13 4a3 3 0 0 1 3 3v11l-5 -5" />
                    <path d="M4 7a3 3 0 0 1 3 -3h10a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3l0 -10" />
                  </svg>
                  Registrar TAG
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header border-0">
          <div class="card-title">Compras de Hoy</div>
        </div>
        <div class="position-relative">
          <div class="position-absolute top-0 left-0 px-3 mt-1 w-75">
            <div class="row g-2">
              <div class="col-auto">
                <div class="chart-sparkline chart-sparkline-square" id="sparkline-activity"></div>
              </div>
              <div class="col">
                <div>Subtotal: $9.850.-</div>
                <div class="text-secondary">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/trending-up -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" class="icon icon-inline text-green icon-3">
                    <path d="M3 17l6 -6l4 4l8 -8" />
                    <path d="M14 7l7 0l0 7" />
                  </svg>
                  +5% más que mes pasado
                </div>
              </div>
            </div>
          </div>
          <div id="chart-development-activity" class="position-relative"></div>
        </div>
        <div class="card-table table-responsive">
          <table class="table table-vcenter">
            <thead>
              <tr>
                <th>Alumno</th>
                <th>Producto</th>
                <th>Valor</th>
                <th>Fecha @ Hora</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="w-1">
                  <span class="avatar avatar-sm avatar-1">JCB</span>
                </td>
                <td class="td-truncate">
                  <div class="text-truncate">Yogu Yogu Mora</div>
                </td>
                <td class="text-nowrap text-secondary">$ 800</td>
                <td class="text-nowrap text-secondary">28 Nov 2025 @ 09:03</td>
              </tr>
              <tr>
                <td class="w-1">
                  <span class="avatar avatar-sm avatar-2">JCB</span>
                </td>
                <td class="td-truncate">
                  <div class="text-truncate">Galleta Avena/Manzana</div>
                </td>
                <td class="text-nowrap text-secondary">$ 900</td>
                <td class="text-nowrap text-secondary">28 Nov 2025 @ 08:47</td>
              </tr>
              <tr>
                <td class="w-1">
                  <span class="avatar avatar-sm avatar-2">TT</span>
                </td>
                <td class="td-truncate">
                  <div class="text-truncate">Abono Web</div>
                </td>
                <td class="text-nowrap text-secondary">$12.000</td>
                <td class="text-nowrap text-secondary">27 Nov 2025 @ 08:12</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-12 col-lg-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Alumnos</h3>
        </div>
        <div class="card-table table-responsive">
          <table class="table table-vcenter">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Compras dia</th>
                <th>Compras Semana</th>
                <th>Compras Mes</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tr>
              <td>Juan Carlos Bodoque</td>
              <td class="text-secondary">$1.300.-</td>
              <td class="text-secondary">$3.200.-</td>
              <td class="text-secondary">$19.850.-</td>
              <td class="text-end">
                <a href="{{ url_for('apoderado_cliente.ficha', id=67)}}" class="btn btn-info btn-sm">Detalles</a>
                <a href="." class="btn btn-danger btn-sm">Bloqueo</a>
                <a href="." class="btn btn-warning btn-sm">Restricciones</a>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Restricciones de Compra</h3>
        </div>
        <table class="table card-table table-vcenter">
          <thead>
            <tr>
              <th>Alumno</th>
              <th>Tipo</th>
              <th>Nombre</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="w-1">
                <span class="avatar avatar-sm" style="background-image: url({{ url_for('static', filename='tabler/static/avatars/000m.jpg', v=app_version)}})"> </span>
              </td>
              <td>Producto</td>
              <td>Galleta Avena Chips</td>
              <td>Alergeno</td>
            </tr>
            <tr>
              <td class="w-1">
                <span class="avatar avatar-sm" style="background-image: url({{ url_for('static', filename='tabler/static/avatars/000m.jpg', v=app_version)}})"> </span>
              </td>
              <td>Categoria</td>
              <td>Cafeteria</td>
              <td>Prohibido por Apoderado</td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-registro-tag" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registrar TAG</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="" method="post" name="asignacion-tag">
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <h3 class="card-title"></h3>
                  <div class="mb-3">
                    <label class="form-label strong">Alumnos sin Tag asignado</label>
                    <select name="alumno_sin_tag" class="form-select" value="">
                      {% for a in alumnos_sin_tag -%}
                      <option value="{{ a.id }}">{{ a.curso }} - {{ a.nombre }}</option>
                      {% endfor-%}
                    </select>
                  </div>
                  <div class="alert alert-info" role="alert">
                    <div class="alert-icon">
                      <!-- Download SVG icon from http://tabler.io/icons/icon/info-circle -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon alert-icon icon-2">
                        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                        <path d="M12 9h.01" />
                        <path d="M11 12h1v4h1" />
                      </svg>
                    </div>
                    Asegurate de tener encendido Bluthooth y NFC.
                  </div>
                  <label class="form-label strong">Número de Serie del sticker NFC</label>
                  <div class="row g-2">
                    <div class="col input-icon">
                      <input type="text" name="tag-nfc" class="form-control" readonly />
                      <span class="input-icon-addon">
                        <div id="spinner-nfc" class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                      </span>
                      <div class="invalid-feedback" id="nfc-error"></div>
                    </div>
                    <div class="col-auto">
                      <button type="button" class="btn btn-2 btn-icon" aria-label="Boton Escanear TAG NFC" id="boton-buscar-tag" onclick="iniciaEscaneo()">
                        <!-- Download SVG icon from http://tabler.io/icons/icon/search -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" class="icon icon-2">
                          <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                          <path d="M21 21l-6 -6" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-footer">
                  <div class="row align-items-center">
                    <div class="col">Aprender más sobre <a href="#">NFC</a></div>
                    <div class="col-auto">
                      <button type="submit" class="btn btn-primary btn-2" id="submit-asigna"> Confirmar Lectura </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-validacion-tag" tabindex="-2" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Valida TAG</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-body">
                <h3 class="card-title"></h3>
                <div class="alert alert-info" role="alert">
                  <div class="alert-icon">
                    <!-- Download SVG icon from http://tabler.io/icons/icon/info-circle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon alert-icon icon-2">
                      <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
                      <path d="M12 9h.01" />
                      <path d="M11 12h1v4h1" />
                    </svg>
                  </div>
                  Asegurate de tener encendido Bluthooth y NFC.
                </div>
                <label class="form-label strong">Número de Serie del sticker NFC</label>
                <div class="row g-2">
                  <div class="col input-icon">
                    <input type="text" value="" name="tag-nfc-valida" class="form-control" readonly />
                    <span class="input-icon-addon">
                      <div id="spinner-nfc-valida" class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>
                    <div class="invalid-feedback" id="nfc-error-valida"></div>
                  </div>
                  <div class="col-auto">
                    <button type="button" class="btn btn-2 btn-icon" aria-label="Boton Escanear TAG NFC" id="boton-valida-tag" onclick="iniciaValidacion()">
                      <!-- Download SVG icon from http://tabler.io/icons/icon/search -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" class="icon icon-2">
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <div class="row align-items-center">
                  <div class="col">Aprender más sobre <a href="#">NFC</a></div>
                  <div class="col-auto">
                    <a href="#" class="btn btn-primary btn-2"> Confirmar Lectura </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock page_body -%}


{% block page_scripts -%}
<script>
  // Unified NFC handler
  function createNFCHandler(config) {
    const { spinnerId, inputName, btnId, errorId, validateOnRead, checkAssignment } = config;

    const spinner = document.getElementById(spinnerId);
    const input = document.querySelector(`input[name="${inputName}"]`);
    const btnScan = document.getElementById(btnId);
    const errorEl = document.getElementById(errorId);

    function setError(msg) {
      errorEl.textContent = msg;
      input.classList.add('is-invalid');
      input.classList.remove('is-valid');
      spinner.style.display = 'none';
      btnScan.disabled = false;
    }

    function setSuccess(msg) {
      errorEl.textContent = '';
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
      spinner.style.display = 'none';
      btnScan.disabled = false;
    }

    function clearError() {
      errorEl.textContent = '';
      input.classList.remove('is-invalid');
    }

    async function validateSerial(serial) {
      try {
        const res = await fetch(`/pos/valida_tag/${serial}`);
        const data = await res.json();

        if (!res.ok) {
          // 404: TAG no existe en el sistema
          if (checkAssignment) {
            // Para asignación: TAG no existe = puede usarse
            setSuccess('TAG disponible para asignación');
            return true;
          } else {
            // Para validación: TAG no existe = error
            setError(data.error || 'TAG no encontrado');
            return false;
          }
        }

        // 200: TAG existe y está asignado
        if (checkAssignment) {
          // Para asignación: TAG ya asignado = error
          setError(data.mensaje || 'TAG ya está asignado a otro alumno');
          return false;
        } else {
          // Para validación: TAG asignado = éxito
          setSuccess(data.mensaje);
          return true;
        }

      } catch (err) {
        setError('Error al validar el TAG. Intente de nuevo.');
        return false;
      }
    }

    async function scan() {
      clearError();

      if (!('NDEFReader' in window)) {
        setError('Tu navegador no soporta NFC. Usa Chrome en Android.');
        return;
      }

      try {
        spinner.style.display = 'block';
        btnScan.disabled = true;

        const ndef = new NDEFReader();
        await ndef.scan();

        ndef.onreading = async ({ serialNumber }) => {
          input.value = serialNumber;

          if (validateOnRead) {
            await validateSerial(serialNumber);
          } else {
            input.classList.add('is-valid');
            spinner.style.display = 'none';
            btnScan.disabled = false;
          }
        };

        ndef.onreadingerror = () => {
          setError('No se pudo leer el TAG. Acerque el sticker e intente de nuevo.');
        };

      } catch (err) {
        setError(`Error al iniciar escaneo: ${err.message}`);
      }
    }

    return { scan };
  }

  // Initialize: Modal de ASIGNACIÓN (checkAssignment = true)
  const nfcAsignar = createNFCHandler({
    spinnerId: 'spinner-nfc',
    inputName: 'tag-nfc',
    btnId: 'boton-buscar-tag',
    errorId: 'nfc-error',
    validateOnRead: true,
    checkAssignment: true  // Lógica invertida: 404=OK, 200=ERROR
  });

  // Initialize: Modal de VALIDACIÓN (checkAssignment = false)
  const nfcValidar = createNFCHandler({
    spinnerId: 'spinner-nfc-valida',
    inputName: 'tag-nfc-valida',
    btnId: 'boton-valida-tag',
    errorId: 'nfc-error-valida',
    validateOnRead: true,
    checkAssignment: false  // Lógica normal: 404=ERROR, 200=OK
  });

  function iniciaEscaneo() {
    nfcAsignar.scan();
  }

  function iniciaValidacion() {
    nfcValidar.scan();
  }

  // Form submission validation para asignación
  document.getElementById('submit-asigna').addEventListener('click', function (e) {
    const input = document.querySelector('input[name="tag-nfc"]');
    const select = document.getElementById('alumno_sin_tag');
    const errorEl = document.getElementById('nfc-error');

    let isValid = true;

    // Validar que el TAG esté escaneado y validado
    if (!input.value || input.classList.contains('is-invalid')) {
      errorEl.textContent = 'Escanee un TAG válido antes de continuar.';
      input.classList.add('is-invalid');
      isValid = false;
    }

    // Validar que haya un alumno seleccionado
    if (!select.value) {
      const selectError = document.createElement('div');
      selectError.className = 'invalid-feedback';
      selectError.textContent = 'Seleccione un alumno.';
      select.classList.add('is-invalid');
      if (!select.nextElementSibling || !select.nextElementSibling.classList.contains('invalid-feedback')) {
        select.parentNode.appendChild(selectError);
      }
      isValid = false;
    } else {
      select.classList.remove('is-invalid');
    }

    if (!isValid) {
      e.preventDefault();
    }
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    window.ApexCharts &&
      new ApexCharts(document.getElementById("chart-development-activity"), {
        chart: {
          type: "area",
          fontFamily: "inherit",
          height: 192,
          sparkline: {
            enabled: false,
          },
          animations: {
            enabled: false,
          },
        },
        dataLabels: {
          enabled: true,
        },
        fill: {
          colors: ["color-mix(in srgb, transparent, var(--tblr-primary) 16%)", "color-mix(in srgb, transparent, var(--tblr-primary) 16%)"],
          type: "solid",
        },
        stroke: {
          width: 2,
          lineCap: "round",
          curve: "smooth",
        },
        series: [
          {
            name: "Compras",
            data: [1300, 1100, 1300, 1250, 900, 1050, 1530, 760, 1300, 1250, 1190, 1100, 950, 1200],
          },
        ],
        tooltip: {
          theme: "dark",
        },
        grid: {
          strokeDashArray: 4,
        },
        xaxis: {
          labels: {
            padding: 0,
          },
          tooltip: {
            enabled: false,
          },
          axisBorder: {
            show: false,
          },
          type: "datetime",
        },
        yaxis: {
          labels: {
            padding: 4,
          },
        },
        labels: [
          "2020-06-20",
          "2020-06-21",
          "2020-06-22",
          "2020-06-23",
          "2020-06-24",
          "2020-06-25",
          "2020-06-26",
          "2020-06-27",
          "2020-06-28",
          "2020-06-29",
          "2020-06-30",
          "2020-07-01",
          "2020-07-02",
          "2020-07-03",
        ],
        colors: ["color-mix(in srgb, transparent, var(--tblr-primary) 100%)"],
        legend: {
          show: true,
        },
        point: {
          show: true,
        },
      }).render();
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var el;
    window.TomSelect &&
      new TomSelect((el = document.getElementById("alumno_sin_tag")), {
        copyClassesToDropdown: false,
        dropdownParent: "body",
        controlInput: "<input>",
        render: {
          item: function (data, escape) {
            if (data.customProperties) {
              return '<div><span class="dropdown-item-indicator">' + data.customProperties + "</span>" + escape(data.text) + "</div>";
            }
            return "<div>" + escape(data.text) + "</div>";
          },
          option: function (data, escape) {
            if (data.customProperties) {
              return '<div><span class="dropdown-item-indicator">' + data.customProperties + "</span>" + escape(data.text) + "</div>";
            }
            return "<div>" + escape(data.text) + "</div>";
          },
        },
      });
  });
</script>
{% endblock page_scripts -%}

{% block head_styles%}
<style>
  #spinner-nfc {
    display: none;
  }

  #spinner-nfc.active {
    display: block;
  }

  #spinner-nfc-valida {
    display: none;
  }

  #spinner-nfc-valida.active {
    display: block;
  }
</style>
{% endblock head_styles %}
