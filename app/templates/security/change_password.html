{% set title = title|default(_fsdomain('Change Password')) %}
{% extends "base.html" %}
{% from "security/_macros.html" import render_field_with_errors, render_field, render_form_errors, render_field_errors %}

{% block page_header -%}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h1 class="page-title">Cambiar Contraseña</h1>
      </div>
    </div>
  </div>
</div>
{% endblock page_header -%}

{% block page_body %}
<div class="page-body">
  <div class="container-xl">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Cambiar Contraseña</h3>
          </div>
          <div class="card-body">
            <form action="{{ url_for_security('change_password') }}" method="post" autocomplete="off" name="change_password_form" class="needs-validation" novalidate>
              {{ change_password_form.hidden_tag() }}
              {{ render_form_errors(change_password_form) }}
              <div class="mb-3">
                <label class="form-label">Contraseña Actual</label>
                <div class="input-group input-group-flat">
                  <input type="password" class="form-control" placeholder="Contraseña actual" autocomplete="current-password" name="password" required />
                </div>
                {{ render_field_errors(change_password_form.password) }}
              </div>
              <div class="mb-3">
                <label class="form-label">Nueva Contraseña</label>
                <div class="input-group input-group-flat mb-2">
                  <input type="password" class="form-control" placeholder="Nueva contraseña" autocomplete="new-password" name="new_password" required />
                  <!-- show-password-toggle.min.js targets this button and renders the eye icon -->
                  <button id="toggle-password" type="button" class="d-none" aria-label="Show password as plain text. Warning: this will display your password on the screen."></button>
                </div>
                {{ render_field_errors(change_password_form.new_password) }}
              </div>
              <div class="mb-3">
                <label class="form-label">Confirmar Nueva Contraseña</label>
                <div class="input-group input-group-flat">
                  <input type="password" id="password_confirm" class="form-control" placeholder="Repite la nueva contraseña" autocomplete="new-password" name="new_password_confirm" required />
                  <span class="input-group-text">
                    <a href="#" class="link-secondary" title="Mostrar contraseña" onclick="return toggleConfirmPassword(this);">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" class="icon icon-1">
                        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                      </svg>
                    </a>
                  </span>
                </div>
                {{ render_field_errors(change_password_form.new_password_confirm) }}
              </div>
              <div class="form-footer">
                {{ render_field_errors(change_password_form.csrf_token) }}
                <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock page_body %}

{% block head_styles %}
<link href="{{ url_for('static', filename='tabler/libs/password-toggle/css/show-password-toggle.min.css', v=app_version)}}" rel="stylesheet" />
{% endblock %}
{% block page_scripts %}
<script src="{{ url_for('static', filename='tabler/libs/password-toggle/js/show-password-toggle.min.js', v=app_version)}}"></script>
<script>
  const form = document.querySelector('.needs-validation');
  form.addEventListener('submit', (e) => {
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
    }
    form.classList.add('was-validated');
  }, false);

  function toggleConfirmPassword(btn) {
    var input = document.getElementById('password_confirm');
    if (input.type === 'password') {
      input.type = 'text';
      btn.setAttribute('aria-label', 'Ocultar contraseña.');
    } else {
      input.type = 'password';
      btn.setAttribute('aria-label', 'Mostrar contraseña.');
    }
    return false;
  }
</script>
{% endblock %}
